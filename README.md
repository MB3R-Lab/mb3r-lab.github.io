# MB3R Lab Landing

Static landing page + Supabase Edge Function backend for pilot onboarding. The UI lives on any static host (GitHub Pages), while a Supabase function receives submissions, stores them in Postgres, and triggers Mailgun emails.

## Architecture

```
Visitor ─► GitHub Pages (index.html, admin.html)
                │
        fetch https://<project>.functions.supabase.co/applications
                │
         Supabase Edge Function
                │
      Postgres (applications table) + Mailgun API
```

If the function is unreachable, the UI falls back to localStorage so leads are not lost; the admin page can still view those cached entries.

## Setup

### 1. Deploy the Supabase function

1. Install the [Supabase CLI](https://supabase.com/docs/guides/cli) and log in:
   ```bash
   supabase login
   supabase link --project-ref YOUR_PROJECT_REF
   ```
2. Configure secrets (service role key, admin password, Mailgun, etc.):
   ```bash
   supabase secrets set \
     ADMIN_PASSWORD="set-a-strong-password" \
     SUPABASE_URL="https://YOUR_PROJECT.supabase.co" \
     SUPABASE_SERVICE_ROLE_KEY="service-role-key" \
     MAIL_FROM="MB3R Lab <noreply@mb3r-lab.org>" \
     MAILGUN_API_KEY="key-..." \
     MAILGUN_DOMAIN="mg.example.com"
   # Optional: MAILGUN_API_BASE_URL=https://api.eu.mailgun.net/v3
   ```
3. Deploy the function:
   ```bash
   supabase functions deploy applications --project-ref YOUR_PROJECT_REF
   ```
   The function ensures the `public.applications` table exists, so no manual migration is required.

### 2. Point the frontend at the function

Edit `assets/js/config.js` and set the function URL (no trailing slash):

```js
window.__MB3R_API_BASE__ = 'https://YOUR_PROJECT_ID.functions.supabase.co';
```

Push the static site (e.g., to GitHub Pages). The landing page and `/admin.html` will now send all API calls to the Supabase function.

## Features

- **CTA + modal form** — collects email/company/context and sends the payload to the Supabase function.
- **Supabase storage** — submissions persist in `public.applications`; schema is autop-created on first call.
- **Mailgun confirmations** — the function posts to Mailgun so every lead receives an acknowledgement email.
- **Admin dashboard** — `/admin.html` lists submissions. Access requires the password that you stored in the function secret (`x-admin-pass` header). If the function is offline, the dashboard shows the locally cached leads.
- **Offline fallback** — when the API is unreachable (or not configured) leads are saved in `localStorage`, so you can later recover them from `/admin`.

## Supabase function behavior

The deployed function handles:

- `POST /applications` — validate payload, insert into `applications`, trigger Mailgun email, respond with the created ID.
- `GET /applications` — require `x-admin-pass` header, return ordered submissions.
- `OPTIONS` — CORS preflight (`*` origin, `content-type` + `x-admin-pass` headers).
- **Schema bootstrap** — executes
  ```sql
  create table if not exists public.applications (
    id bigint generated by default as identity primary key,
    email text not null,
    company text not null,
    comment text,
    created_at timestamptz not null default now()
  );
  ```
  via `rest/v1/rpc/exec_sql` whenever it detects that the table is missing.

## Local testing

1. Duplicate your secrets in a local `.env.functions` file (key=value per line).
2. Run the function locally:
   ```bash
   supabase functions serve applications --env-file .env.functions
   ```
3. Update `assets/js/config.js` to point at the local URL printed by the CLI (e.g., `http://127.0.0.1:54321/functions/v1`), then open `index.html` directly and test the flow.

Remember to switch `config.js` back to the production URL before committing.
